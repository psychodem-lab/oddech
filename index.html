<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trening Oddechowy</title>
<link rel="shortcut icon" type="image/png" href="favicon.png" />
<style>
Â  Â  :root{
Â  Â  Â  Â  --bg-color:#f0f4f8;
Â  Â  Â  Â  --circle-color:#4a90e2;
Â  Â  Â  Â  --text-color:#333;
Â  Â  Â  Â  --panel-bg:#ffffff;
Â  Â  Â  Â  --success-color:#2ecc71;
Â  Â  Â  Â  --danger-color:#e74c3c;
Â  Â  Â  Â  --mute-color:#f39c12;
Â  Â  Â  Â  --card-shadow: 0 3px 10px rgba(0,0,0,0.08);
Â  Â  Â  Â  --radius:12px;
Â  Â  }

Â  Â  *{box-sizing:border-box}
Â  Â  html,body{height:100%}
Â  Â  body{
Â  Â  Â  Â  margin:0;
Â  Â  Â  Â  padding:18px;
Â  Â  Â  Â  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â  Â  Â  Â  background:var(--bg-color);
Â  Â  Â  Â  color:var(--text-color);
Â  Â  Â  Â  display:flex;
Â  Â  Â  Â  flex-direction:column;
Â  Â  Â  Â  align-items:center;
Â  Â  Â  Â  justify-content:flex-start;
Â  Â  Â  Â  min-height:100vh;
Â  Â  Â  Â  overflow-y:auto;
Â  Â  Â  Â  text-align:center;
Â  Â  }

Â  Â  .container{
Â  Â  Â  Â  width:100%;
Â  Â  Â  Â  max-width:920px;
Â  Â  Â  Â  display:flex;
Â  Â  Â  Â  gap:20px;
Â  Â  Â  Â  align-items:flex-start;
Â  Â  Â  Â  justify-content:center;
Â  Â  Â  Â  flex-wrap:wrap;
Â  Â  }

Â  Â  .visualizer {
Â  Â  Â  Â  background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.85));
Â  Â  Â  Â  border-radius:var(--radius);
Â  Â  Â  Â  padding:20px;
Â  Â  Â  Â  box-shadow:var(--card-shadow);
Â  Â  Â  Â  display:flex;
Â  Â  Â  Â  flex-direction:column;
Â  Â  Â  Â  gap:14px;
Â  Â  Â  Â  align-items:center;
Â  Â  Â  Â  width:320px;
Â  Â  Â  Â  flex-shrink:0;
Â  Â  }

Â  Â  .visualizer-container{
Â  Â  Â  Â  position:relative;
Â  Â  Â  Â  width:280px;
Â  Â  Â  Â  height:280px;
Â  Â  Â  Â  display:flex;
Â  Â  Â  Â  align-items:center;
Â  Â  Â  Â  justify-content:center;
Â  Â  }

Â  Â  .breathing-circle{
Â  Â  Â  Â  width:140px;
Â  Â  Â  Â  height:140px;
Â  Â  Â  Â  background-color:var(--circle-color);
Â  Â  Â  Â  border-radius:50%;
Â  Â  Â  Â  position:absolute;
Â  Â  Â  Â  z-index:1;
Â  Â  Â  Â  opacity:0.95;
Â  Â  Â  Â  box-shadow:0 0 25px rgba(74,144,226,0.35);
Â  Â  Â  Â  transform:scale(1);
Â  Â  Â  Â  transition:transform 600ms ease-in-out;
Â  Â  }

Â  Â  .instruction-text{
Â  Â  Â  Â  position:relative;
Â  Â  Â  Â  z-index:2;
Â  Â  Â  Â  font-size:1.25rem;
Â  Â  Â  Â  font-weight:700;
Â  Â  Â  Â  color:white;
Â  Â  Â  Â  text-shadow:0 2px 6px rgba(0,0,0,0.25);
Â  Â  Â  Â  pointer-events:none;
Â  Â  Â  Â  user-select:none;
Â  Â  }

Â  Â  .controls{
Â  Â  Â  Â  background:var(--panel-bg);
Â  Â  Â  Â  padding:16px;
Â  Â  Â  Â  border-radius:var(--radius);
Â  Â  Â  Â  box-shadow:var(--card-shadow);
Â  Â  Â  Â  display:flex;
Â  Â  Â  Â  flex-direction:column;
Â  Â  Â  Â  gap:12px;
Â  Â  Â  Â  width:320px;
Â  Â  Â  Â  flex-shrink:0;
Â  Â  }

Â  Â  .inputs-grid{
Â  Â  Â  Â  display:grid;
Â  Â  Â  Â  grid-template-columns:1fr 1fr;
Â  Â  Â  Â  gap:10px;
Â  Â  }

Â  Â  .input-group{ display:flex; flex-direction:column; align-items:center; }
Â  Â  .input-group label{ font-size:0.78rem; margin-bottom:4px; color:#666; text-align:center; }
Â  Â  .input-group input{
Â  Â  Â  Â  width:100%;
Â  Â  Â  Â  max-width:120px;
Â  Â  Â  Â  padding:8px 6px;
Â  Â  Â  Â  border:1px solid #ddd;
Â  Â  Â  Â  border-radius:8px;
Â  Â  Â  Â  font-size:0.95rem;
Â  Â  Â  Â  text-align:center;
Â  Â  }

Â  Â  .input-group.total-time-input{ grid-column:span 2; }

Â  Â  .session-timer{ font-weight:600; color:#222; }

Â  Â  .buttons{ display:flex; gap:8px; }
Â  Â  button{
Â  Â  Â  Â  flex:1;
Â  Â  Â  Â  padding:10px;
Â  Â  Â  Â  border:none;
Â  Â  Â  Â  border-radius:8px;
Â  Â  Â  Â  font-size:0.95rem;
Â  Â  Â  Â  cursor:pointer;
Â  Â  Â  Â  font-weight:700;
Â  Â  Â  Â  transition:background 0.15s ease;
Â  Â  }
Â  Â  #start-btn{ background-color:var(--success-color); color:white; }
Â  Â  #start-btn:hover{ background-color:#27ae60; }
Â  Â  #stop-btn{ background-color:var(--danger-color); color:white; }
Â  Â  #stop-btn:hover{ background-color:#c0392b; }
Â  Â  #mute-btn{
Â  Â  Â  Â  background-color:var(--mute-color);
Â  Â  Â  Â  color:white;
Â  Â  Â  Â  padding:10px;
Â  Â  Â  Â  border-radius:8px;
Â  Â  }
Â  Â  #mute-btn.muted{ background:#95a5a6; }
Â  Â  button:disabled{ opacity:0.55; cursor:not-allowed; }

Â  Â  .meta{
Â  Â  Â  Â  font-size:0.9rem;
Â  Â  Â  Â  color:#666;
Â  Â  }

Â  Â  /* responsywnoÅ›Ä‡ */
Â  Â  @media (max-width:700px){
Â  Â  Â  Â  .container{ padding:0 8px; }
Â  Â  Â  Â  .visualizer, .controls{ width:100%; max-width:420px; }
Â  Â  Â  Â  .visualizer-container{ width:220px; height:220px; }
Â  Â  Â  Â  .breathing-circle{ width:110px; height:110px; }
Â  Â  }
</style>
</head>
<body>
Â  Â  <h1 style="margin:0 0 12px 0; font-size:1.1rem;">Trening oddechowy</h1>

Â  Â  <div class="container" role="application" aria-label="Trening oddechowy">
Â  Â  Â  Â  <section class="visualizer" aria-labelledby="vis-title">
Â  Â  Â  Â  Â  Â  <div id="vis-title" style="display:none">Wizualizacja oddechu</div>
Â  Â  Â  Â  Â  Â  <div class="visualizer-container" aria-hidden="false">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="breathing-circle" id="circle" aria-hidden="true"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="instruction-text" id="text">Gotowy?</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>

Â  Â  Â  Â  <aside class="controls" aria-labelledby="controls-title">
Â  Â  Â  Â  Â  Â  <h2 id="controls-title" style="margin:0; font-size:0.95rem;">Sterowanie</h2>

Â  Â  Â  Â  Â  Â  <div class="inputs-grid">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="inhale">Wdech (sek)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="inhale" value="4" min="1" step="0.1" aria-label="Wdech w sekundach">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="hold1">Zatrzymaj 1 (sek)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="hold1" value="2" min="0" step="0.1" aria-label="Zatrzymaj po wdechu">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="exhale">Wydech (sek)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="exhale" value="6" min="1" step="0.1" aria-label="Wydech w sekundach">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="hold2">Zatrzymaj 2 (sek)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="hold2" value="2" min="0" step="0.1" aria-label="Zatrzymaj po wydechu">
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="input-group total-time-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="totalTime">Czas treningu (min)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" id="totalTime" value="2" min="0.5" step="0.5" aria-label="Czas treningu w minutach">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="session-timer" aria-live="polite">
Â  Â  Â  Â  Â  Â  Â  Â  Czas do koÅ„ca: <span id="session-countdown">00:00</span>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="buttons" style="margin-top:8px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="start-btn" type="button" aria-pressed="false">Start</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="stop-btn" type="button" disabled>Stop</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:8px; margin-top:8px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="mute-btn" type="button" aria-pressed="true" class="muted">ðŸ”Š WÅ‚Ä…cz dÅºwiÄ™k</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  </aside>
Â  Â  </div>

<script>
/*
Â  Skrypt poprawiony:
Â  - CaÅ‚kowita cisza przy starcie w trybie wyciszonym (brak "blipniÄ™cia")
Â  - DomyÅ›lny start bez dÅºwiÄ™ku
Â  - Wake Lock API
Â  - DODANO: Wymuszenie wyciszenia w startBreathing, aby uniknÄ…Ä‡ blipniÄ™cia po startSound.
*/

'use strict';

/* --- Konfiguracja dÅºwiÄ™ku --- */
const FREQ_START = 164.8;
const FREQ_END = 329.6;
const VOLUME_MAX = 0.28;
const FADE_MS = 200;Â 

/* --- Elementy DOM --- */
const circle = document.getElementById('circle');
const textDisplay = document.getElementById('text');
const startBtn = document.getElementById('start-btn');
const stopBtn = document.getElementById('stop-btn');
const muteBtn = document.getElementById('mute-btn');
const inputs = document.querySelectorAll('input');
const countdownDisplay = document.getElementById('session-countdown');

let audioContext = null;
let oscillator = null;
let gainNode = null;
let isRunning = false;
let isMuted = true; // DomyÅ›lnie wyciszone
let sessionTimerInterval = null;
let remainingTimeMs = 0;
let wakeLock = null;

/* Utility sleep */
const wait = ms => new Promise(resolve => setTimeout(resolve, ms));

/* --- Wake Lock API --- */
async function requestWakeLock() {
Â  Â  if ('wakeLock' in navigator) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  wakeLock = await navigator.wakeLock.request('screen');
Â  Â  Â  Â  Â  Â  wakeLock.addEventListener('release', () => {});
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  console.warn(`Wake Lock err: ${err.message}`);
Â  Â  Â  Â  }
Â  Â  }
}

async function releaseWakeLock() {
Â  Â  if (wakeLock !== null) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await wakeLock.release();
Â  Â  Â  Â  Â  Â  wakeLock = null;
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  console.warn(`Release Lock err: ${err.message}`);
Â  Â  Â  Â  }
Â  Â  }
}

/* --- Audio helpers --- */
async function ensureAudioContext() {
Â  Â  if (!audioContext) {
Â  Â  Â  Â  audioContext = new (window.AudioContext || window.webkitAudioContext)();
Â  Â  } else if (audioContext.state === 'suspended') {
Â  Â  Â  Â  try { await audioContext.resume(); } catch(e){ console.warn('resume failed', e); }
Â  Â  }
Â  Â  return audioContext;
}

function createOscillatorAndGain() {
Â  Â  if (!audioContext) throw new Error('AudioContext nie istnieje');
Â  Â  const osc = audioContext.createOscillator();
Â  Â  osc.type = 'sine';
Â  Â  osc.frequency.setValueAtTime(FREQ_START, audioContext.currentTime);

Â  Â  const gain = audioContext.createGain();
Â  Â  // Inicjalizacja ABSOLUTNYM ZEREM
Â  Â  gain.gain.setValueAtTime(0.0, audioContext.currentTime);

Â  Â  osc.connect(gain);
Â  Â  gain.connect(audioContext.destination);

Â  Â  return { osc, gain };
}

function setVolume(target, durationS = 0.2) {
Â  Â  if (!gainNode) return;
Â  Â  const t = audioContext.currentTime;
Â  Â  try {
Â  Â  Â  Â  gainNode.gain.cancelScheduledValues(t);
Â  Â  Â  Â  gainNode.gain.setValueAtTime(gainNode.gain.value, t);
Â  Â  Â  Â  gainNode.gain.linearRampToValueAtTime(target, t + durationS);
Â  Â  } catch (e) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  gainNode.gain.linearRampToValueAtTime(target, t + durationS);
Â  Â  Â  Â  } catch (err) {}
Â  Â  }
}

function transitionFrequency(targetFreq, durationMs = 0) {
Â  Â  if (!oscillator) return;
Â  Â  const durS = durationMs / 1000;
Â  Â  const t = audioContext.currentTime;
Â  Â  try {
Â  Â  Â  Â  oscillator.frequency.cancelScheduledValues(t);
Â  Â  Â  Â  oscillator.frequency.setValueAtTime(oscillator.frequency.value || FREQ_START, t);
Â  Â  Â  Â  if (durS > 0) oscillator.frequency.linearRampToValueAtTime(targetFreq, t + durS);
Â  Â  Â  Â  else oscillator.frequency.setValueAtTime(targetFreq, t);
Â  Â  } catch (e) {
Â  Â  Â  Â  try { oscillator.frequency.linearRampToValueAtTime(targetFreq, t + durS); } catch (err) {}
Â  Â  }
}

/* Start dÅºwiÄ™ku */
async function startSound() {
Â  Â  await ensureAudioContext();

Â  Â  if (oscillator) {
Â  Â  Â  Â  try { oscillator.stop(); oscillator.disconnect(); } catch (e) {}
Â  Â  Â  Â  oscillator = null;
Â  Â  }
Â  Â  if (gainNode) {
Â  Â  Â  Â  try { gainNode.disconnect(); } catch(e) {}
Â  Â  Â  Â  gainNode = null;
Â  Â  }

Â  Â  const nodes = createOscillatorAndGain();
Â  Â  oscillator = nodes.osc;
Â  Â  gainNode = nodes.gain;

Â  Â  oscillator.start();

Â  Â  // POPRAWKA: JeÅ›li jest wyciszony, wymuszamy 0 natychmiastowo, bez FADE_MS
Â  Â  if (!isMuted) {
Â  Â  Â  Â  setVolume(VOLUME_MAX, FADE_MS / 1000);
Â  Â  } else {
Â  Â  Â  Â  // Natychmiastowe 0, Å¼eby uniknÄ…Ä‡ "blipniÄ™cia" przy starcie
Â  Â  Â  Â  gainNode.gain.cancelScheduledValues(audioContext.currentTime);
Â  Â  Â  Â  gainNode.gain.setValueAtTime(0, audioContext.currentTime);
Â  Â  }
Â  Â Â 
Â  Â  transitionFrequency(FREQ_START, 0);
}

async function stopSoundAndCleanup() {
Â  Â  if (!audioContext || !gainNode) return;
Â  Â  try {
Â  Â  Â  Â  // Szybki fade out przy stopie tylko jeÅ›li nie byÅ‚o wyciszone
Â  Â  Â  Â  if (!isMuted) setVolume(0, 0.15);
Â  Â  Â  Â  else gainNode.gain.setValueAtTime(0, audioContext.currentTime);

Â  Â  Â  Â  await wait(200);
Â  Â  Â  Â  if (oscillator) {
Â  Â  Â  Â  Â  Â  try { oscillator.stop(); } catch (e) {}
Â  Â  Â  Â  Â  Â  try { oscillator.disconnect(); } catch (e) {}
Â  Â  Â  Â  Â  Â  oscillator = null;
Â  Â  Â  Â  }
Â  Â  Â  Â  try { gainNode.disconnect(); } catch (e) {}
Â  Â  Â  Â  gainNode = null;

Â  Â  Â  Â  if (audioContext && typeof audioContext.close === 'function') {
Â  Â  Â  Â  Â  Â  await audioContext.close();
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.warn('Cleanup audio failed', e);
Â  Â  } finally {
Â  Â  Â  Â  audioContext = null;
Â  Â  }
}

/* --- Sesja oddechowa --- */
function validateInputs(inhaleS, hold1S, exhaleS, hold2S, totalMinutes) {
Â  Â  if (!(isFinite(inhaleS) && inhaleS > 0)) return 'Wdech musi byÄ‡ > 0.';
Â  Â  if (!(isFinite(exhaleS) && exhaleS > 0)) return 'Wydech musi byÄ‡ > 0.';
Â  Â  if (!(isFinite(totalMinutes) && totalMinutes >= 0.5)) return 'Czas treningu musi byÄ‡ co najmniej 0.5 minuty.';
Â  Â  if (hold1S < 0 || hold2S < 0) return 'Czasy zatrzymania nie mogÄ… byÄ‡ ujemne.';
Â  Â  return null;
}

function updateTimerDisplay(ms) {
Â  Â  const totalSeconds = Math.max(0, Math.floor(ms / 1000));
Â  Â  const minutes = Math.floor(totalSeconds / 60);
Â  Â  const seconds = totalSeconds % 60;
Â  Â  countdownDisplay.innerText = String(minutes).padStart(2,'0') + ':' + String(seconds).padStart(2,'0');
}

function toggleControls(active) {
Â  Â  startBtn.disabled = active;
Â  Â  stopBtn.disabled = !active;
Â  Â  inputs.forEach(i => i.disabled = active);
}

function forceReflow(el) {
Â  Â  void el.offsetHeight;
}

async function runBreathingLoop(inhaleMs, hold1Ms, exhaleMs, hold2Ms) {
Â  Â  while (isRunning && remainingTimeMs > 0) {
Â  Â  Â  Â  // WDECH
Â  Â  Â  Â  textDisplay.innerText = 'Wdech';
Â  Â  Â  Â  circle.style.transition = `transform ${inhaleMs}ms ease-in-out`;
Â  Â  Â  Â  forceReflow(circle);
Â  Â  Â  Â  circle.style.transform = 'scale(2.0)';
Â  Â  Â  Â  transitionFrequency(FREQ_END, inhaleMs);
Â  Â  Â  Â  if (!isMuted) setVolume(VOLUME_MAX, 0.1);
Â  Â  Â  Â  await wait(inhaleMs);
Â  Â  Â  Â  if (!isRunning) break;

Â  Â  Â  Â  // ZATRZYMANIE 1
Â  Â  Â  Â  if (hold1Ms > 0) {
Â  Â  Â  Â  Â  Â  textDisplay.innerText = 'Zatrzymaj';
Â  Â  Â  Â  Â  Â  circle.style.transition = 'none';
Â  Â  Â  Â  Â  Â  transitionFrequency(FREQ_END, 0);
Â  Â  Â  Â  Â  Â  if (!isMuted) setVolume(0.02, 0.1); // Bardzo ciche tÅ‚o, tylko jeÅ›li niewyciszone
Â  Â  Â  Â  Â  Â  else setVolume(0, 0);
Â  Â  Â  Â  Â  Â  await wait(hold1Ms);
Â  Â  Â  Â  Â  Â  if (!isRunning) break;
Â  Â  Â  Â  }

Â  Â  Â  Â  // WYDECH
Â  Â  Â  Â  textDisplay.innerText = 'Wydech';
Â  Â  Â  Â  circle.style.transition = `transform ${exhaleMs}ms ease-in-out`;
Â  Â  Â  Â  forceReflow(circle);
Â  Â  Â  Â  circle.style.transform = 'scale(1.0)';
Â  Â  Â  Â  transitionFrequency(FREQ_START, exhaleMs);
Â  Â  Â  Â  if (!isMuted) setVolume(VOLUME_MAX, 0.1);
Â  Â  Â  Â  await wait(exhaleMs);
Â  Â  Â  Â  if (!isRunning) break;

Â  Â  Â  Â  // ZATRZYMANIE 2
Â  Â  Â  Â  if (hold2Ms > 0) {
Â  Â  Â  Â  Â  Â  textDisplay.innerText = 'Zatrzymaj';
Â  Â  Â  Â  Â  Â  circle.style.transition = 'none';
Â  Â  Â  Â  Â  Â  transitionFrequency(FREQ_START, 0);
Â  Â  Â  Â  Â  Â  if (!isMuted) setVolume(0.02, 0.1);
Â  Â  Â  Â  Â  Â  else setVolume(0, 0);
Â  Â  Â  Â  Â  Â  await wait(hold2Ms);
Â  Â  Â  Â  Â  Â  if (!isRunning) break;
Â  Â  Â  Â  }
Â  Â  }
}

async function startBreathing() {
Â  Â  if (isRunning) return;

Â  Â  const inhaleS = parseFloat(document.getElementById('inhale').value);
Â  Â  const hold1S = parseFloat(document.getElementById('hold1').value);
Â  Â  const exhaleS = parseFloat(document.getElementById('exhale').value);
Â  Â  const hold2S = parseFloat(document.getElementById('hold2').value);
Â  Â  const totalMinutes = parseFloat(document.getElementById('totalTime').value);

Â  Â  const validationError = validateInputs(inhaleS, hold1S, exhaleS, hold2S, totalMinutes);
Â  Â  if (validationError) {
Â  Â  Â  Â  alert(validationError);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const inhaleMs = Math.round(inhaleS * 1000);
Â  Â  const hold1Ms = Math.round(hold1S * 1000);
Â  Â  const exhaleMs = Math.round(exhaleS * 1000);
Â  Â  const hold2Ms = Math.round(hold2S * 1000);

Â  Â  remainingTimeMs = Math.round(totalMinutes * 60 * 1000);

Â  Â  isRunning = true;
Â  Â  toggleControls(true);
Â  Â  textDisplay.innerText = 'Rozpoczynam...';

Â  Â  await requestWakeLock();

Â  Â  try {
Â  Â  Â  Â  await startSound();
Â  Â  } catch (e) {
Â  Â  Â  Â  console.warn('Audio err', e);
Â  Â  }

Â  Â  // ZMIANA: Wymusza natychmiastowe wyciszenie po starcie Audio Contextu, 
    // aby zapobiec ewentualnemu chwilowemu 'blipniÄ™ciu' przed wejÅ›ciem w pÄ™tlÄ™.
    if (isMuted) setVolume(0, 0); // <--- DODANA LINIA

Â  Â  updateTimerDisplay(remainingTimeMs);
Â  Â  sessionTimerInterval = setInterval(() => {
Â  Â  Â  Â  remainingTimeMs -= 1000;
Â  Â  Â  Â  if (remainingTimeMs < 0) remainingTimeMs = 0;
Â  Â  Â  Â  updateTimerDisplay(remainingTimeMs);
Â  Â  Â  Â  if (remainingTimeMs <= 0) {
Â  Â  Â  Â  Â  Â  clearInterval(sessionTimerInterval);
Â  Â  Â  Â  Â  Â  sessionTimerInterval = null;
Â  Â  Â  Â  Â  Â  stopBreathing('Trening zakoÅ„czony! Dobra robota!');
Â  Â  Â  Â  }
Â  Â  }, 1000);

Â  Â  try {
Â  Â  Â  Â  await runBreathingLoop(inhaleMs, hold1Ms, exhaleMs, hold2Ms);
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error('Loop err', e);
Â  Â  }

Â  Â  if (isRunning) {
Â  Â  Â  Â  stopBreathing('Gotowy?');
Â  Â  }
}

async function stopBreathing(finalMessage = 'Gotowy?') {
Â  Â  if (!isRunning) {
Â  Â  Â  Â  await stopSoundAndCleanup();
Â  Â  Â  Â  await releaseWakeLock();
Â  Â  Â  Â  textDisplay.innerText = finalMessage;
Â  Â  Â  Â  updateTimerDisplay(0);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  isRunning = false;
Â  Â  toggleControls(false);

Â  Â  if (sessionTimerInterval) {
Â  Â  Â  Â  clearInterval(sessionTimerInterval);
Â  Â  Â  Â  sessionTimerInterval = null;
Â  Â  }

Â  Â  textDisplay.innerText = finalMessage;
Â  Â  circle.style.transition = 'transform 450ms ease-out';
Â  Â  forceReflow(circle);
Â  Â  circle.style.transform = 'scale(1)';

Â  Â  await stopSoundAndCleanup();
Â  Â  await releaseWakeLock();

Â  Â  if (finalMessage === 'Gotowy?') updateTimerDisplay(0);
Â  Â  toggleControls(false);
}

/* --- Mute UI --- */
function updateMuteUI() {
Â  Â  if (isMuted) {
Â  Â  Â  Â  muteBtn.classList.add('muted');
Â  Â  Â  Â  muteBtn.innerText = 'ðŸ”Š WÅ‚Ä…cz dÅºwiÄ™k';
Â  Â  Â  Â  muteBtn.setAttribute('aria-pressed','true');
Â  Â  } else {
Â  Â  Â  Â  muteBtn.classList.remove('muted');
Â  Â  Â  Â  muteBtn.innerText = 'ðŸ”‡ Wycisz dÅºwiÄ™k';
Â  Â  Â  Â  muteBtn.setAttribute('aria-pressed','false');
Â  Â  }
}

function toggleMute() {
Â  Â  isMuted = !isMuted;
Â  Â  updateMuteUI();
Â  Â  if (!gainNode) return;
Â  Â  if (isMuted) {
Â  Â  Â  Â  setVolume(0, 0.15);
Â  Â  } else {
Â  Â  Â  Â  setVolume(isRunning ? VOLUME_MAX : 0, 0.2);
Â  Â  }
}

/* --- Eventy --- */
startBtn.addEventListener('click', () => startBreathing().catch(console.error));
stopBtn.addEventListener('click', () => stopBreathing('Gotowy?').catch(console.error));
muteBtn.addEventListener('click', toggleMute);

document.addEventListener('keydown', (ev) => {
Â  Â  if (ev.key === 'Enter') {
Â  Â  Â  Â  if (!isRunning && !startBtn.disabled) startBtn.click();
Â  Â  } else if (ev.key === 'Escape') {
Â  Â  Â  Â  if (isRunning && !stopBtn.disabled) stopBtn.click();
Â  Â  }
});

document.addEventListener('DOMContentLoaded', () => {
Â  Â  const totalMinutes = parseFloat(document.getElementById('totalTime').value) || 0;
Â  Â  const initialMs = Math.round(Math.max(0.5, totalMinutes) * 60 * 1000);
Â  Â  updateTimerDisplay(initialMs);
Â  Â  updateMuteUI();
});

window.addEventListener('beforeunload', (e) => {
Â  Â  if (isRunning) { e.preventDefault(); e.returnValue = ''; }
});
</script>
</body>
</html>
