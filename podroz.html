<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Trip PRO v2.1</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;700&display=swap');

        :root {
            --primary: #00f2fe;
            --danger: #ff0055;
            --gold: #ffd700;
        }

        body {
            margin: 0; padding: 0;
            display: flex; justify_content: center; align-items: center;
            height: 100vh; background-color: #000;
            font-family: 'Rajdhani', sans-serif; overflow: hidden;
            color: white; user-select: none;
        }

        #game-wrapper {
            position: relative;
            width: 100%; max-width: 450px;
            height: 100%; max-height: 800px;
            background: #000; overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 242, 254, 0.1);
        }

        canvas {
            display: block; width: 100%; height: 100%;
            filter: drop-shadow(0 0 4px rgba(255,255,255,0.3)); 
        }

        .ui-panel {
            position: absolute; pointer-events: none;
            width: 100%; height: 100%; top: 0; left: 0;
            display: flex; flex-direction: column; justify-content: space-between;
            padding: 20px; box-sizing: border-box; z-index: 10;
        }

        .hud-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .score-box { font-size: 32px; font-weight: bold; text-shadow: 0 0 10px rgba(0,242,254,0.5); }
        .currency-box { 
            color: var(--gold); font-size: 22px; display: flex; align-items: center; gap: 5px; 
            background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 20px;
            border: 1px solid rgba(255,215,0,0.3);
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 5, 30, 0.9); backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20; transition: opacity 0.3s; pointer-events: auto;
        }

        .hidden { display: none !important; }

        h1 { 
            font-size: 48px; margin: 0 0 20px 0; text-transform: uppercase; letter-spacing: 5px; 
            background: linear-gradient(to bottom, #fff, var(--primary));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        button {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary); border: 2px solid var(--primary);
            padding: 15px 40px; font-size: 20px; font-family: inherit;
            font-weight: bold; text-transform: uppercase; cursor: pointer;
            margin: 10px; border-radius: 40px; transition: all 0.2s;
            min-width: 200px;
        }

        button:hover { background: var(--primary); color: #000; box-shadow: 0 0 30px var(--primary); }
        button.secondary { border-color: #fff; color: #fff; }

        #shop-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0;
        }
        .shop-item {
            width: 80px; height: 80px; border: 3px solid #444; border-radius: 15px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; background: rgba(255,255,255,0.05);
        }
        .shop-item.active { border-color: #00ff00; background: rgba(0,255,0,0.1); }
        .shop-item.locked { opacity: 0.7; }
        .price-tag { font-size: 14px; color: var(--gold); margin-top: 5px; }

        #notification {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            background: var(--danger); padding: 10px 20px; border-radius: 30px;
            font-weight: bold; opacity: 0; transition: opacity 0.3s; z-index: 100;
        }
    </style>
</head>
<body>

<div id="game-wrapper">
    <canvas id="gameCanvas"></canvas>
    
    <div class="ui-panel">
        <div class="hud-top">
            <div>
                <div class="score-box"><span id="scoreVal">0</span> m</div>
                <div style="font-size: 14px; opacity: 0.7;">Best: <span id="highScoreVal">0</span></div>
            </div>
            <div class="currency-box">üíé <span id="coinsVal">0</span></div>
        </div>
        <div id="shield-indicator" style="color: var(--danger); font-weight: bold; text-align: center; opacity: 0;">üõ°Ô∏è TARCZA AKTYWNA</div>
    </div>

    <div id="start-screen" class="screen">
        <h1>NEON TRIP</h1>
        <button id="btn-start-main">Graj</button>
        <button id="btn-shop-main" class="secondary">Gara≈º</button>
    </div>

    <div id="shop-screen" class="screen hidden">
        <h1>SKLEP</h1>
        <div id="shop-grid"></div>
        <button id="btn-back-main" class="secondary">Powr√≥t</button>
    </div>

    <div id="gameover-screen" class="screen hidden">
        <h1 style="color: var(--danger);">KRACH</h1>
        <p style="font-size: 24px;">Dystans: <span id="final-score">0</span>m</p>
        <button id="btn-restart-go">Spr√≥buj ponownie</button>
        <button id="btn-shop-go" class="secondary">Sklep</button>
        <button id="btn-share-go" style="font-size: 14px; padding: 10px; border: none; background: none;">Udostƒôpnij wynik</button>
    </div>

    <div id="notification">Za ma≈Ço diament√≥w!</div>
</div>

<script>
/**
 * PE≈ÅNA IMPLEMENTACJA GRY - SILNIK V2.1
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreVal = document.getElementById('scoreVal');
const coinsVal = document.getElementById('coinsVal');
const highScoreVal = document.getElementById('highScoreVal');

let width, height;
function resize() {
    width = canvas.width = document.getElementById('game-wrapper').offsetWidth;
    height = canvas.height = document.getElementById('game-wrapper').offsetHeight;
}
window.addEventListener('resize', resize);
resize();

// --- STAN GRY ---
const game = {
    state: 'START',
    score: 0,
    coins: parseInt(localStorage.getItem('neonCoins')) || 0,
    highScore: parseInt(localStorage.getItem('neonHighScore')) || 0,
    frames: 0,
    stage: 0,
    speed: 3.5,
    lastGapY: height / 2, // ≈öledzenie ostatniej luki dla przejezdno≈õci
    skin: parseInt(localStorage.getItem('neonSkin')) || 0,
    unlockedSkins: JSON.parse(localStorage.getItem('neonSkinsUnlocked')) || [0]
};

const skins = [
    { name: 'B≈Çƒôkit', color: '#00f2fe', price: 0 },
    { name: 'Neon', color: '#ff0055', price: 50 },
    { name: 'Z≈Çoto', color: '#ffd700', price: 150 },
    { name: 'Plazma', color: '#00ff00', price: 300 }
];

// --- AUDIO ---
const Audio = {
    ctx: null,
    init() {
        if (this.ctx) return;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
    },
    play(freq, type = 'sine', duration = 0.1, vol = 0.1) {
        if (!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
        osc.connect(g); g.connect(this.ctx.destination);
        osc.start(); osc.stop(this.ctx.currentTime + duration);
    }
};

// --- KLASY OBIEKT√ìW ---

class Particle {
    constructor(x, y, color, type = 'trail') {
        this.x = x; this.y = y;
        this.color = color;
        this.size = Math.random() * 4 + 2;
        this.vx = type === 'shatter' ? (Math.random() - 0.5) * 10 : -game.speed;
        this.vy = type === 'shatter' ? (Math.random() - 0.5) * 10 : 0;
        this.life = 1.0;
        this.decay = type === 'shatter' ? 0.02 : 0.05;
    }
    update() {
        this.x += this.vx; this.y += this.vy; this.life -= this.decay;
    }
    draw() {
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1;
    }
}

class Bubble {
    constructor() {
        this.radius = 18;
        this.reset();
    }
    reset() {
        this.x = 80; this.y = height / 2;
        this.vy = 0; this.gravity = 0.25;
        this.jumpForce = -5.5;
        this.hasShield = false;
        this.particles = [];
    }
    jump() {
        this.vy = this.jumpForce;
        Audio.play(400, 'sine', 0.1);
    }
    update() {
        // Grawitacja adaptacyjna (punkt 6)
        let g = game.stage === 3 ? 0.15 : 0.25;
        this.vy += g;
        this.y += this.vy;

        // ≈ölad (punkt 11)
        if (game.frames % 3 === 0) {
            this.particles.push(new Particle(this.x, this.y, skins[game.skin].color));
        }

        // ≈ömierƒá przez granice
        if (this.y + this.radius > height || this.y - this.radius < 0) return true;
        
        this.particles.forEach((p, i) => {
            p.update();
            if (p.life <= 0) this.particles.splice(i, 1);
        });
        return false;
    }
    draw() {
        this.particles.forEach(p => p.draw());
        ctx.save();
        ctx.shadowBlur = 15; ctx.shadowColor = skins[game.skin].color;
        ctx.beginPath(); ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
        ctx.fillStyle = 'rgba(255,255,255,0.2)'; ctx.fill();
        ctx.strokeStyle = this.hasShield ? '#fff' : skins[game.skin].color;
        ctx.lineWidth = 3; ctx.stroke();
        // Odblask
        ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(this.x-6, this.y-6, 4, 0, Math.PI*2); ctx.fill();
        ctx.restore();
    }
}

class Obstacle {
    constructor() {
        this.w = 60;
        this.gap = 190;
        this.x = width;
        
        // --- LOGIKA PRZEJEZDNO≈öCI ---
        // Obliczamy zasiƒôg w jakim bƒÖbelek mo≈ºe siƒô przemie≈õciƒá od ostatniej luki
        const maxRise = 120; // Ile bƒÖbelek mo≈ºe "wskoczyƒá"
        const maxDrop = 150; // Ile bƒÖbelek mo≈ºe opa≈õƒá
        
        let minY = Math.max(80, game.lastGapY - maxRise);
        let maxY = Math.min(height - this.gap - 80, game.lastGapY + maxDrop);
        
        this.topH = Math.random() * (maxY - minY) + minY;
        game.lastGapY = this.topH; // Zapamiƒôtaj dla nastƒôpnej przeszkody

        this.passed = false;
        this.item = Math.random() < 0.2 ? (Math.random() < 0.15 ? 'shield' : 'coin') : null;
    }
    update() {
        this.x -= game.speed;
    }
    draw() {
        const color = skins[game.skin].color;
        ctx.save();
        ctx.shadowBlur = 10; ctx.shadowColor = color;
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;

        // G√≥rny filar
        ctx.fillRect(this.x, 0, this.w, this.topH);
        ctx.strokeRect(this.x, 0, this.w, this.topH);
        // Dolny filar
        const bottomY = this.topH + this.gap;
        ctx.fillRect(this.x, bottomY, this.w, height - bottomY);
        ctx.strokeRect(this.x, bottomY, this.w, height - bottomY);

        if (this.item) {
            ctx.fillStyle = this.item === 'coin' ? '#ffd700' : '#ff0055';
            ctx.beginPath(); ctx.arc(this.x + this.w/2, this.topH + this.gap/2, 10, 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();
    }
}

// --- SILNIK GRY ---
const bubble = new Bubble();
let obstacles = [];
let globalParticles = [];
let bgOffset = 0;

function resetGame() {
    game.score = 0; game.frames = 0; game.stage = 0; game.speed = 3.5;
    game.lastGapY = height / 2;
    bubble.reset();
    obstacles = [new Obstacle()];
    globalParticles = [];
    updateHUD();
}

function updateHUD() {
    scoreVal.innerText = Math.floor(game.score);
    coinsVal.innerText = game.coins;
    highScoreVal.innerText = game.highScore;
    document.getElementById('shield-indicator').style.opacity = bubble.hasShield ? 1 : 0;
}

function spawnShatter(x, y, color) {
    for(let i=0; i<20; i++) globalParticles.push(new Particle(x, y, color, 'shatter'));
}

function loop() {
    if (game.state !== 'PLAY') return;

    ctx.clearRect(0,0,width,height);
    
    // Paralaksa (punkt 9)
    bgOffset -= game.speed * 0.2;
    ctx.fillStyle = '#0a051e'; ctx.fillRect(0,0,width,height);
    ctx.fillStyle = 'rgba(255,255,255,0.05)';
    for(let i=0; i<20; i++) ctx.fillRect((bgOffset + i*100) % width, (i*37)%height, 2, 2);

    if (game.frames % 90 === 0) obstacles.push(new Obstacle());

    // Przeszkody
    for (let i = obstacles.length - 1; i >= 0; i--) {
        const o = obstacles[i];
        o.update(); o.draw();

        // Kolizja przedmiot√≥w
        if (o.item) {
            const dx = bubble.x - (o.x + o.w/2);
            const dy = bubble.y - (o.topH + o.gap/2);
            if (Math.sqrt(dx*dx + dy*dy) < bubble.radius + 15) {
                if (o.item === 'coin') { game.coins++; Audio.play(800, 'sine', 0.2); }
                else { bubble.hasShield = true; Audio.play(600, 'square', 0.3); }
                o.item = null; updateHUD();
            }
        }

        // Kolizja przeszk√≥d
        if (bubble.x + bubble.radius > o.x && bubble.x - bubble.radius < o.x + o.w) {
            if (bubble.y - bubble.radius < o.topH || bubble.y + bubble.radius > o.topH + o.gap) {
                if (bubble.hasShield) {
                    bubble.hasShield = false; o.passed = true;
                    spawnShatter(bubble.x, bubble.y, '#fff');
                    Audio.play(200, 'sawtooth', 0.4);
                } else {
                    endGame();
                }
            }
        }

        if (o.x + o.w < 0) obstacles.splice(i, 1);
    }

    if (bubble.update()) endGame();
    bubble.draw();

    globalParticles.forEach((p, i) => {
        p.update(); p.draw();
        if (p.life <= 0) globalParticles.splice(i, 1);
    });

    game.score += 0.05;
    game.frames++;
    if (game.frames % 50 === 0) updateHUD();
    requestAnimationFrame(loop);
}

function endGame() {
    game.state = 'GAMEOVER';
    Audio.play(100, 'sawtooth', 0.5);
    spawnShatter(bubble.x, bubble.y, skins[game.skin].color);
    
    if (game.score > game.highScore) {
        game.highScore = Math.floor(game.score);
        localStorage.setItem('neonHighScore', game.highScore);
    }
    localStorage.setItem('neonCoins', game.coins);
    
    document.getElementById('final-score').innerText = Math.floor(game.score);
    document.getElementById('gameover-screen').classList.remove('hidden');
}

// --- SKLEP I UI ---
function renderShop() {
    const grid = document.getElementById('shop-grid');
    grid.innerHTML = '';
    skins.forEach((s, i) => {
        const isUnlocked = game.unlockedSkins.includes(i);
        const div = document.createElement('div');
        div.className = `shop-item ${game.skin === i ? 'active' : ''} ${!isUnlocked ? 'locked' : ''}`;
        div.style.color = s.color;
        div.innerHTML = `
            <div style="width:20px;height:20px;border-radius:50%;background:${s.color};box-shadow:0 0 10px ${s.color}"></div>
            <div class="price-tag">${isUnlocked ? 'POSIADANE' : s.price + 'üíé'}</div>
        `;
        div.onclick = () => {
            if (isUnlocked) {
                game.skin = i; localStorage.setItem('neonSkin', i); renderShop();
            } else if (game.coins >= s.price) {
                game.coins -= s.price; game.unlockedSkins.push(i);
                game.skin = i;
                localStorage.setItem('neonCoins', game.coins);
                localStorage.setItem('neonSkinsUnlocked', JSON.stringify(game.unlockedSkins));
                localStorage.setItem('neonSkin', i);
                updateHUD(); renderShop();
            } else {
                const n = document.getElementById('notification');
                n.style.opacity = 1; setTimeout(() => n.style.opacity = 0, 2000);
            }
        };
        grid.appendChild(div);
    });
}

// --- LISTENERS ---
document.getElementById('btn-start-main').onclick = () => { 
    Audio.init(); game.state = 'PLAY'; 
    document.getElementById('start-screen').classList.add('hidden'); 
    resetGame(); loop(); 
};
document.getElementById('btn-restart-go').onclick = () => { 
    game.state = 'PLAY'; 
    document.getElementById('gameover-screen').classList.add('hidden'); 
    resetGame(); loop(); 
};
document.getElementById('btn-shop-main').onclick = () => {
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('shop-screen').classList.remove('hidden');
    renderShop();
};
document.getElementById('btn-shop-go').onclick = () => {
    document.getElementById('gameover-screen').classList.add('hidden');
    document.getElementById('shop-screen').classList.remove('hidden');
    renderShop();
};
document.getElementById('btn-back-main').onclick = () => {
    document.getElementById('shop-screen').classList.add('hidden');
    document.getElementById('start-screen').classList.remove('hidden');
};

window.addEventListener('keydown', (e) => { if(e.code === 'Space' && game.state === 'PLAY') bubble.jump(); });
canvas.addEventListener('touchstart', (e) => { e.preventDefault(); if(game.state === 'PLAY') bubble.jump(); });
canvas.addEventListener('mousedown', () => { if(game.state === 'PLAY') bubble.jump(); });

document.getElementById('btn-share-go').onclick = () => {
    const txt = `M√≥j rekord w Neon Trip to ${Math.floor(game.score)}m! Spr√≥buj pobiƒá: ${window.location.href}`;
    navigator.clipboard.writeText(txt).then(() => alert("Skopiowano do schowka!"));
};

updateHUD();
</script>
</body>
</html>
