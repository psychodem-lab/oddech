<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wirtualny Las - Poziomy</title>
    <style>
        body { 
            background: #eef5ee; margin: 0; overflow: hidden; 
            display: flex; flex-direction: column; align-items: center; 
            font-family: 'Segoe UI', sans-serif; color: #2d5a27;
        }
        canvas { 
            background: linear-gradient(to bottom, #87CEEB 0%, #e0f7fa 100%);
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            border-radius: 30px; margin-top: 20px;
            max-width: 95vw; max-height: 55vh; border: 8px solid white;
        }
        .ui { text-align: center; padding: 10px; }
        .stats { font-weight: bold; font-size: 1.2rem; margin-bottom: 5px; color: #1b5e20; }
        .controls { display: flex; gap: 40px; margin-top: 20px; }
        .btn {
            width: 80px; height: 80px; background: #ffffff; border: none;
            border-radius: 50%; box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            font-size: 32px; cursor: pointer; color: #4facfe;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.2s; user-select: none;
        }
        .btn:active { transform: scale(0.9); background: #f0f0f0; }
    </style>
</head>
<body>

<div class="ui">
    <div class="stats" id="levelDisplay">Poziom 1</div>
    <p id="taskInfo" style="margin:0; opacity: 0.8;">Podlewaj drzewa, aż wszystkie urosną!</p>
</div>

<canvas id="forestCanvas" width="800" height="450"></canvas>

<div class="controls">
    <button class="btn" id="left">◀</button>
    <button class="btn" id="right">▶</button>
</div>

<script>
    const canvas = document.getElementById("forestCanvas");
    const ctx = canvas.getContext("2d");

    let level = 1;
    let cloudX = canvas.width / 2 - 50;
    let rightPressed = false;
    let leftPressed = false;
    let levelUpAnim = 0; // Do animacji napisu Level Up

    let trees = [];
    const numTrees = 5;

    function initTrees() {
        trees = [];
        // Z każdym poziomem drzewa mogą rosnąć wyżej
        const targetHeight = 100 + (level * 40);
        for(let i=0; i < numTrees; i++) {
            trees.push({
                x: 120 + i * 140,
                height: 10,
                maxHeight: targetHeight + Math.random() * 50,
                color: (100 + (level * 30)) % 360, // Zmiana koloru co poziom
                sway: Math.random() * Math.PI
            });
        }
    }

    initTrees();

    // Sterowanie
    const setL = (v) => leftPressed = v;
    const setR = (v) => rightPressed = v;
    document.getElementById('left').onmousedown = () => setL(true);
    document.getElementById('left').onmouseup = () => setL(false);
    document.getElementById('right').onmousedown = () => setR(true);
    document.getElementById('right').onmouseup = () => setR(false);
    document.addEventListener('keydown', (e) => {
        if(e.key === "ArrowLeft") setL(true);
        if(e.key === "ArrowRight") setR(true);
    });
    document.addEventListener('keyup', (e) => {
        if(e.key === "ArrowLeft") setL(false);
        if(e.key === "ArrowRight") setR(false);
    });

    function drawCloud(x, y) {
        ctx.save();
        ctx.translate(x, y);
        // Deszcz
        ctx.strokeStyle = "rgba(100, 180, 255, 0.6)";
        ctx.lineWidth = 2;
        for(let i=0; i<8; i++) {
            let dropOffset = (Date.now() / 4 + i * 15) % 60;
            ctx.beginPath();
            ctx.moveTo(i * 12, 30 + dropOffset);
            ctx.lineTo(i * 12, 40 + dropOffset);
            ctx.stroke();
        }
        // Chmura
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(0, 0, 30, 0, Math.PI * 2);
        ctx.arc(35, -15, 45, 0, Math.PI * 2);
        ctx.arc(80, 0, 35, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
    }

    function drawTree(tree) {
        const sway = Math.sin(Date.now() / 1000 + tree.sway) * 2;
        ctx.fillStyle = "#5d4037";
        const trunkW = 4 + (tree.height / 50);
        ctx.fillRect(tree.x - trunkW/2 + sway, canvas.height - tree.height - 20, trunkW, tree.height);

        if(tree.height > 20) {
            let leafSize = tree.height * 0.4;
            ctx.fillStyle = `hsl(${tree.color}, 60%, ${30 + (tree.height/10)}%)`;
            ctx.beginPath();
            ctx.arc(tree.x + sway, canvas.height - tree.height - 30, leafSize, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    function checkLevelComplete() {
        const allGrown = trees.every(t => t.height >= t.maxHeight - 5);
        if (allGrown) {
            level++;
            levelUpAnim = 100; // Start animacji
            document.getElementById('levelDisplay').innerText = "Poziom " + level;
            initTrees();
        }
    }

    function update() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Niebo zmienia kolor w zależności od poziomu
        ctx.fillStyle = "#689f38";
        ctx.fillRect(0, canvas.height - 20, canvas.width, 20);

        if(rightPressed && cloudX < canvas.width - 120) cloudX += 5;
        if(leftPressed && cloudX > -20) cloudX -= 5;

        drawCloud(cloudX, 70);

        trees.forEach(tree => {
            if(cloudX < tree.x + 30 && cloudX + 90 > tree.x) {
                if(tree.height < tree.maxHeight) {
                    tree.height += 0.3;
                }
            }
            drawTree(tree);
        });

        // Pasek postępu poziomu (średnia wysokość wszystkich drzew)
        const totalMax = trees.reduce((sum, t) => sum + t.maxHeight, 0);
        const totalCurrent = trees.reduce((sum, t) => sum + t.height, 0);
        const progress = totalCurrent / totalMax;
        
        ctx.fillStyle = "rgba(0,0,0,0.1)";
        ctx.fillRect(200, 20, 400, 10);
        ctx.fillStyle = "#4caf50";
        ctx.fillRect(200, 20, 400 * progress, 10);

        // Animacja Level Up
        if(levelUpAnim > 0) {
            ctx.fillStyle = `rgba(45, 90, 39, ${levelUpAnim/100})`;
            ctx.font = "bold 40px Segoe UI";
            ctx.textAlign = "center";
            ctx.fillText("POZIOM UKOŃCZONY!", canvas.width/2, canvas.height/2);
            levelUpAnim--;
        }

        checkLevelComplete();
        requestAnimationFrame(update);
    }

    update();
</script>

</body>
</html>
