<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trening Oddechowy z KontrolÄ… DÅºwiÄ™ku</title>
<link rel="shortcut icon" type="image/png" href="favicon.png" />

<style>
/* ===========================
   STYLES
   =========================== */

:root{
    --bg-color:#f0f4f8;
    --circle-color:#4a90e2;
    --text-color:#333;
    --panel-bg:#ffffff;
    --success-color:#2ecc71;
    --danger-color:#e74c3c;
    --mute-color:#f39c12;
    --card-shadow: 0 3px 10px rgba(0,0,0,0.08);
    --radius:12px;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
    margin:0;
    padding:18px;
    font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background:var(--bg-color);
    color:var(--text-color);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    min-height:100vh;
    overflow-y:auto;
    text-align:center;
}

.container{
    width:100%;
    max-width:920px;
    display:flex;
    gap:20px;
    align-items:flex-start;
    justify-content:center;
    flex-wrap:wrap;
}

.visualizer{
    background:linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.85));
    border-radius:var(--radius);
    padding:20px;
    box-shadow:var(--card-shadow);
    display:flex;
    flex-direction:column;
    gap:14px;
    align-items:center;
    width:320px;
    flex-shrink:0;
}

.visualizer-container{
    position:relative;
    width:280px;
    height:280px;
    display:flex;
    align-items:center;
    justify-content:center;
}

.breathing-circle{
    width:140px;
    height:140px;
    background-color:var(--circle-color);
    border-radius:50%;
    position:absolute;
    z-index:1;
    opacity:0.95;
    box-shadow:0 0 25px rgba(74,144,226,0.35);
    transform:scale(1);
    transition:transform 600ms ease-in-out;
}

.instruction-text{
    position:relative;
    z-index:2;
    font-size:1.25rem;
    font-weight:700;
    color:white;
    text-shadow:0 2px 6px rgba(0,0,0,0.25);
    user-select:none;
}

.controls{
    background:var(--panel-bg);
    padding:16px;
    border-radius:var(--radius);
    box-shadow:var(--card-shadow);
    display:flex;
    flex-direction:column;
    gap:12px;
    width:320px;
    flex-shrink:0;
}

.inputs-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
}

.input-group{ display:flex; flex-direction:column; align-items:center; }
.input-group label{ font-size:0.78rem; margin-bottom:4px; color:#666; text-align:center; }
.input-group input{
    width:100%;
    max-width:120px;
    padding:8px 6px;
    border:1px solid #ddd;
    border-radius:8px;
    font-size:0.95rem;
    text-align:center;
}

.input-group.total-time-input{ grid-column:span 2; }

.session-timer{ font-weight:600; color:#222; }

.buttons{ display:flex; gap:8px; }
button{
    flex:1;
    padding:10px;
    border:none;
    border-radius:8px;
    font-size:0.95rem;
    cursor:pointer;
    font-weight:700;
    transition:background 0.15s ease;
}
#start-btn{ background-color:var(--success-color); color:#fff; }
#start-btn:hover{ background-color:#27ae60; }
#stop-btn{ background-color:var(--danger-color); color:#fff; }
#stop-btn:hover{ background-color:#c0392b; }

#mute-btn{
    background-color:var(--mute-color);
    color:white;
    padding:10px;
    border-radius:8px;
}
#mute-btn.muted{
    background:#95a5a6;
}

button:disabled{ opacity:0.55; cursor:not-allowed; }

.meta{ font-size:0.9rem; color:#666; }

@media (max-width:700px){
    .visualizer, .controls{
        width:100%;
        max-width:420px;
    }
    .visualizer-container{
        width:220px;
        height:220px;
    }
    .breathing-circle{
        width:110px;
        height:110px;
    }
}
</style>
</head>


<body>
<h1 style="margin:0 0 12px 0; font-size:1.1rem;">Trening oddechowy â€” dÅºwiÄ™k + wizualizacja</h1>

<div class="container" role="application" aria-label="Trening oddechowy">
    <section class="visualizer">
        <div class="visualizer-container">
            <div class="breathing-circle" id="circle"></div>
            <div class="instruction-text" id="text">Gotowy?</div>
        </div>
        <div class="meta">Porusz koÅ‚em podczas oddechu â€” dÅºwiÄ™k dopasowuje siÄ™ do faz.</div>
    </section>

    <aside class="controls">
        <h2 style="margin:0; font-size:0.95rem;">Sterowanie</h2>

        <div class="inputs-grid">
            <div class="input-group">
                <label for="inhale">Wdech (sek)</label>
                <input type="number" id="inhale" value="4" min="1" step="0.1">
            </div>
            <div class="input-group">
                <label for="hold1">Zatrzymaj 1 (sek)</label>
                <input type="number" id="hold1" value="2" min="0" step="0.1">
            </div>
            <div class="input-group">
                <label for="exhale">Wydech (sek)</label>
                <input type="number" id="exhale" value="6" min="1" step="0.1">
            </div>
            <div class="input-group">
                <label for="hold2">Zatrzymaj 2 (sek)</label>
                <input type="number" id="hold2" value="2" min="0" step="0.1">
            </div>

            <div class="input-group total-time-input">
                <label for="totalTime">Czas treningu (min)</label>
                <input type="number" id="totalTime" value="2" min="0.5" step="0.5">
            </div>
        </div>

        <div class="session-timer">Czas do koÅ„ca: <span id="session-countdown">00:00</span></div>

        <div class="buttons">
            <button id="start-btn" type="button">Start</button>
            <button id="stop-btn" type="button" disabled>Stop</button>
        </div>

        <div style="display:flex; gap:8px; margin-top:8px;">
            <button id="mute-btn" type="button">ðŸ”‡ Wycisz dÅºwiÄ™k</button>
        </div>

    </aside>
</div>


<script>
/* ===========================
   ULEPSZONY SKRYPT AUDIO + LOGIKA SESJI
   =========================== */

'use strict';

const FREQ_START = 164.8;
const FREQ_END = 329.6;
const VOLUME_MAX = 0.28;
const FADE_MS = 200;

const circle = document.getElementById('circle');
const textDisplay = document.getElementById('text');
const startBtn = document.getElementById('start-btn');
const stopBtn = document.getElementById('stop-btn');
const muteBtn = document.getElementById('mute-btn');
const inputs = document.querySelectorAll('input');
const countdownDisplay = document.getElementById('session-countdown');

let audioContext = null;
let oscillator = null;
let gainNode = null;
let isRunning = false;
let isMuted = false;
let sessionTimerInterval = null;
let remainingTimeMs = 0;

const wait = ms => new Promise(res => setTimeout(res, ms));

async function ensureAudioContext() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioContext.state === 'suspended') {
        try { await audioContext.resume(); } catch(e){}
    }
}

function createOscillatorAndGain() {
    const osc = audioContext.createOscillator();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(FREQ_START, audioContext.currentTime);

    const gain = audioContext.createGain();
    gain.gain.setValueAtTime(0, audioContext.currentTime);

    osc.connect(gain);
    gain.connect(audioContext.destination);
    return { osc, gain };
}

function setVolume(target, seconds = 0.2) {
    if (!gainNode) return;
    const t = audioContext.currentTime;
    gainNode.gain.cancelScheduledValues(t);
    const current = gainNode.gain.getValueAtTime(t);
    gainNode.gain.setValueAtTime(current, t);
    gainNode.gain.linearRampToValueAtTime(target, t + seconds);
}

function transitionFrequency(target, ms = 0) {
    if (!oscillator) return;
    const t = audioContext.currentTime;
    const dur = ms / 1000;
    const currentFreq = oscillator.frequency.getValueAtTime(t);
    oscillator.frequency.cancelScheduledValues(t);
    oscillator.frequency.setValueAtTime(currentFreq || FREQ_START, t);
    oscillator.frequency.linearRampToValueAtTime(target, t + dur);
}

async function startSound() {
    await ensureAudioContext();

    if (oscillator) {
        try { oscillator.stop(); } catch(e){}
        try { oscillator.disconnect(); } catch(e){}
    }
    if (gainNode) {
        try { gainNode.disconnect(); } catch(e){}
    }

    const nodes = createOscillatorAndGain();
    oscillator = nodes.osc;
    gainNode = nodes.gain;

    oscillator.start();

    setVolume(isMuted ? 0 : VOLUME_MAX, FADE_MS / 1000);
    transitionFrequency(FREQ_START, 0);
}

async function stopSoundAndCleanup() {
    if (!audioContext || !gainNode) return;

    setVolume(0, 0.25);
    await wait(300);

    if (oscillator) {
        try { oscillator.stop(); } catch(e){}
        try { oscillator.disconnect(); } catch(e){}
        oscillator = null;
    }
    try { gainNode.disconnect(); } catch(e){}
    gainNode = null;

    // NIE zamykamy AudioContext! (problem iOS)
}

function validateInputs(inhaleS, hold1S, exhaleS, hold2S, totalMin) {
    if (!(isFinite(inhaleS) && inhaleS > 0)) return 'Wdech musi byÄ‡ > 0.';
    if (!(isFinite(exhaleS) && exhaleS > 0)) return 'Wydech musi byÄ‡ > 0.';
    if (!(isFinite(totalMin) && totalMin >= 0.5)) return 'Czas treningu min. 0.5 minuty.';
    if (hold1S < 0 || hold2S < 0) return 'Czasy zatrzymania nie mogÄ… byÄ‡ ujemne.';
    return null;
}

function updateTimerDisplay(ms) {
    const sec = Math.max(0, Math.floor(ms / 1000));
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    countdownDisplay.innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function toggleControls(active) {
    startBtn.disabled = active;
    stopBtn.disabled = !active;
    inputs.forEach(i => i.disabled = active);
}

function forceReflow(el) { void el.offsetHeight; }

async function runBreathingLoop(inhaleMs, hold1Ms, exhaleMs, hold2Ms) {
    while (isRunning && remainingTimeMs > 0) {

        textDisplay.innerText = 'Wdech';
        circle.style.transition = `transform ${inhaleMs}ms ease-in-out`;
        forceReflow(circle);
        circle.style.transform = 'scale(2)';
        transitionFrequency(FREQ_END, inhaleMs);
        if (!isMuted) setVolume(VOLUME_MAX, 0.1);
        await wait(inhaleMs);
        if (!isRunning) break;

        if (hold1Ms > 0) {
            textDisplay.innerText = 'Zatrzymaj';
            circle.style.transition = 'none';
            forceReflow(circle);
            await Promise.resolve();
            transitionFrequency(FREQ_END, 0);
            setVolume(0, 0.05);
            await wait(hold1Ms);
            if (!isRunning) break;
        }

        textDisplay.innerText = 'Wydech';
        circle.style.transition = `transform ${exhaleMs}ms ease-in-out`;
        forceReflow(circle);
        circle.style.transform = 'scale(1)';
        transitionFrequency(FREQ_START, exhaleMs);
        if (!isMuted) setVolume(VOLUME_MAX, 0.1);
        await wait(exhaleMs);
        if (!isRunning) break;

        if (hold2Ms > 0) {
            textDisplay.innerText = 'Zatrzymaj';
            circle.style.transition = 'none';
            forceReflow(circle);
            await Promise.resolve();
            transitionFrequency(FREQ_START, 0);
            setVolume(0, 0.05);
            await wait(hold2Ms);
            if (!isRunning) break;
        }
    }
}

async function startBreathing() {
    if (isRunning) return;

    const inhaleS = parseFloat(inhale.value);
    const hold1S = parseFloat(hold1.value);
    const exhaleS = parseFloat(exhale.value);
    const hold2S = parseFloat(hold2.value);
    const totalMin = parseFloat(totalTime.value);

    const err = validateInputs(inhaleS, hold1S, exhaleS, hold2S, totalMin);
    if (err) return alert(err);

    const inhaleMs = inhaleS * 1000;
    const hold1Ms = hold1S * 1000;
    const exhaleMs = exhaleS * 1000;
    const hold2Ms = hold2S * 1000;

    remainingTimeMs = totalMin * 60 * 1000;

    isRunning = true;
    toggleControls(true);
    textDisplay.innerText = 'Rozpoczynam...';

    try { await startSound(); } catch(e){}

    updateTimerDisplay(remainingTimeMs);

    sessionTimerInterval = setInterval(() => {
        remainingTimeMs -= 1000;
        if (remainingTimeMs < 0) remainingTimeMs = 0;
        updateTimerDisplay(remainingTimeMs);
        if (remainingTimeMs <= 0) {
            clearInterval(sessionTimerInterval);
            sessionTimerInterval = null;
            stopBreathing('Trening zakoÅ„czony! Dobra robota!');
        }
    }, 1000);

    await runBreathingLoop(inhaleMs, hold1Ms, exhaleMs, hold2Ms);

    if (isRunning) stopBreathing('Gotowy?');
}

async function stopBreathing(finalMessage = 'Gotowy?') {
    if (!isRunning) {
        await stopSoundAndCleanup();
        textDisplay.innerText = finalMessage;
        updateTimerDisplay(0);
        return;
    }

    isRunning = false;
    toggleControls(false);

    if (sessionTimerInterval) {
        clearInterval(sessionTimerInterval);
        sessionTimerInterval = null;
    }

    textDisplay.innerText = finalMessage;
    circle.style.transition = 'transform 450ms ease-out';
    forceReflow(circle);
    circle.style.transform = 'scale(1)';

    await stopSoundAndCleanup();

    if (finalMessage === 'Gotowy?') updateTimerDisplay(0);
}

function updateMuteUI() {
    if (isMuted) {
        muteBtn.classList.add('muted');
        muteBtn.innerText = 'ðŸ”Š WÅ‚Ä…cz dÅºwiÄ™k';
    } else {
        muteBtn.classList.remove('muted');
        muteBtn.innerText = 'ðŸ”‡ Wycisz dÅºwiÄ™k';
    }
}

function toggleMute() {
    isMuted = !isMuted;
    updateMuteUI();
    if (!gainNode) return;
    setVolume(isMuted ? 0 : (isRunning ? VOLUME_MAX : 0), 0.15);
}

startBtn.addEventListener('click', () => startBreathing());
stopBtn.addEventListener('click', () => stopBreathing('Gotowy?'));
muteBtn.addEventListener('click', () => toggleMute());

document.addEventListener('keydown', (ev) => {
    if (ev.key === 'Enter' && ev.target.tagName !== 'INPUT') {
        if (!isRunning && !startBtn.disabled) startBtn.click();
    }
    if (ev.key === 'Escape') {
        if (isRunning && !stopBtn.disabled) stopBtn.click();
    }
});

document.addEventListener('DOMContentLoaded', () => {
    const totalMin = parseFloat(totalTime.value) || 1;
    updateTimerDisplay(totalMin * 60 * 1000);
    updateMuteUI();
});

window.addEventListener('beforeunload', (e) => {
    if (isRunning) {
        e.preventDefault();
        e.returnValue = '';
    }
});
</script>

</body>
</html>
