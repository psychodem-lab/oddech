<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Literak Pro</title>
    <style>
        :root {
            --primary: #4a90e2; --success: #27ae60; --gold: #f1c40f; --danger: #e74c3c;
            --bg: #f0f2f5; --panel-bg: #ffffff; --text-main: #2c3e50; --border: #eeeeee;
        }
        body.dark-mode {
            --bg: #121212; --panel-bg: #1e1e1e; --text-main: #e0e0e0; --border: #333333;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text-main); margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        .game-container { background: var(--panel-bg); width: 100%; max-width: 500px; display: flex; flex-direction: column; padding: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.2); }
        
        /* Ekran wczytywania */
        #setupOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--panel-bg); z-index: 100; display: flex;
            flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px;
        }

        .letters-pills { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin: 10px 0; }
        .letter { 
            background: var(--primary); color: white; aspect-ratio: 1/1; 
            display: flex; align-items: center; justify-content: center; 
            border-radius: 8px; font-size: 1.4rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 3px 0 #357abd;
        }
        .letter.used { opacity: 0.3; transform: translateY(2px); box-shadow: none; }
        
        .input-area { display: flex; gap: 6px; height: 50px; margin-bottom: 10px; }
        input { flex: 2; border: 2px solid var(--border); border-radius: 8px; font-size: 1.2rem; text-align: center; text-transform: uppercase; background: var(--bg); color: var(--text-main); }
        
        .results { flex-grow: 1; border: 1px solid var(--border); border-radius: 8px; padding: 10px; overflow-y: auto; background: var(--bg); }
        .word-tag { display: inline-block; background: #e1f5fe; color: #0277bd; padding: 4px 10px; border-radius: 12px; margin: 3px; font-size: 0.9rem; cursor: pointer; }
        
        button { border: none; border-radius: 8px; font-weight: bold; cursor: pointer; padding: 10px; }
        .btn-main { background: var(--success); color: white; }
        .btn-alt { background: var(--primary); color: white; }
        .loader { display: none; margin: 10px; font-size: 0.8rem; color: var(--primary); }
    </style>
</head>
<body>

<div id="setupOverlay">
    <h2>Witaj w Literaku!</h2>
    <p>Aby grać offline i błyskawicznie, wybierz raz plik <b>odm.txt</b>.<br>Przeglądarka go zapamięta.</p>
    <input type="file" id="dictInput" accept=".txt" style="display: none;">
    <button class="btn-main" onclick="document.getElementById('dictInput').click()">WYBIERZ PLIK ODM.TXT</button>
    <div id="setupStatus" style="margin-top: 15px; font-size: 0.8rem; color: var(--text-main);">Oczekiwanie na plik...</div>
</div>

<div class="game-container">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1 style="font-size: 1.2rem;">Literak Pro</h1>
        <div>Wynik: <span id="currentScore" style="font-weight: bold; color: var(--primary);">0</span></div>
    </div>
    
    <div id="msg" style="text-align: center; height: 20px; font-size: 0.8rem; margin: 5px 0;"></div>
    
    <div class="letters-pills" id="lettersGroup"></div>

    <div class="input-area">
        <button onclick="removeLastLetter()" style="background: #e67e22; color: white;">⌫</button>
        <input type="text" id="wordInput" readonly placeholder="...">
        <button class="btn-main" onclick="processWord()">OK</button>
    </div>

    <div class="results" id="foundList"></div>

    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn-alt" style="flex: 1;" onclick="shufflePool()">MIESZAJ</button>
        <button class="btn-alt" style="flex: 1; background: #95a5a6;" onclick="startNewGame()">NOWE LITERY</button>
    </div>
</div>

<script>
    let dictionarySet = new Set();
    let state = { pool: [], found: [], score: 0 };
    let usedIndices = [];
    const letterScores = {'A':1, 'E':1, 'I':1, 'O':1, 'N':1, 'Z':1, 'R':1, 'S':1, 'W':1, 'Y':2, 'C':2, 'D':2, 'K':2, 'L':2, 'M':2, 'P':2, 'T':2, 'B':3, 'G':3, 'H':3, 'J':3, 'Ł':3, 'U':3, 'Ą':5, 'Ę':5, 'F':5, 'Ó':5, 'Ś':5, 'Ż':5, 'Ć':6, 'Ń':7, 'Ź':9};

    // --- LOGIKA BAZY DANYCH (IndexedDB) ---
    const dbName = "LiterakDB";
    function initDB() {
        const request = indexedDB.open(dbName, 1);
        request.onupgradeneeded = e => e.target.result.createObjectStore("settings");
        request.onsuccess = e => {
            const db = e.target.result;
            const transaction = db.transaction("settings", "readonly");
            const getReq = transaction.objectStore("settings").get("dictionary");
            getReq.onsuccess = () => {
                if (getReq.result) {
                    dictionarySet = getReq.result;
                    document.getElementById('setupOverlay').style.display = 'none';
                    startNewGame();
                }
            };
        };
    }

    document.getElementById('dictInput').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        document.getElementById('setupStatus').innerText = "Przetwarzanie słownika... (może to potrwać kilka sekund)";
        
        reader.onload = function(res) {
            const lines = res.target.result.split(/\r?\n/);
            const tempSet = new Set();
            lines.forEach(line => {
                const words = line.split(', ');
                words.forEach(w => {
                    const clean = w.trim().toUpperCase();
                    if(clean.length >= 2 && clean.length <= 10) tempSet.add(clean);
                });
            });
            
            // Zapis do IndexedDB
            const dbReq = indexedDB.open(dbName, 1);
            dbReq.onsuccess = e => {
                const db = e.target.result;
                const tx = db.transaction("settings", "readwrite");
                tx.objectStore("settings").put(tempSet, "dictionary");
                tx.oncomplete = () => {
                    dictionarySet = tempSet;
                    document.getElementById('setupOverlay').style.display = 'none';
                    startNewGame();
                };
            };
        };
        reader.readAsText(file);
    };

    // --- LOGIKA GRY ---
    function startNewGame() {
        const vowels = "AAAAAAAAAEEEEEEEEIIIIIIOOOOOOOUUY";
        const cons = "BBCCCCDDDDFFGGHHHHJJKKKLLLLŁŁŁMMMMNNNNNNPPPPPRRRRRSSSSSTTTTTWWWWWWZZZZZ";
        let temp = [];
        for(let i=0; i<4; i++) temp.push(vowels[Math.floor(Math.random()*vowels.length)]);
        for(let i=0; i<6; i++) temp.push(cons[Math.floor(Math.random()*cons.length)]);
        state.pool = temp.sort(() => Math.random()-0.5);
        state.found = [];
        state.score = 0;
        renderAll();
    }

    function processWord() {
        const word = document.getElementById('wordInput').value;
        if (word.length < 2) return;
        if (state.found.includes(word)) { updateMsg("Już jest!", "orange"); resetSelection(); return; }

        if (dictionarySet.has(word)) {
            let pts = 0;
            for(let c of word) pts += (letterScores[c] || 1);
            state.score += pts;
            state.found.push(word);
            updateMsg(`+${pts} PKT!`, "green");
            renderAll();
        } else {
            updateMsg("Nie ma w słowniku!", "red");
        }
        resetSelection();
    }

    function renderAll() {
        const group = document.getElementById('lettersGroup');
        group.innerHTML = "";
        state.pool.forEach((char, i) => {
            const div = document.createElement('div');
            div.className = 'letter' + (usedIndices.includes(i) ? ' used' : '');
            div.innerText = char;
            div.onclick = () => {
                if(usedIndices.includes(i)) return;
                usedIndices.push(i);
                document.getElementById('wordInput').value += char;
                renderAll();
            };
            group.appendChild(div);
        });
        
        document.getElementById('currentScore').innerText = state.score;
        const list = document.getElementById('foundList');
        list.innerHTML = state.found.map(w => `<span class="word-tag">${w}</span>`).reverse().join('');
    }

    function removeLastLetter() {
        if(usedIndices.length === 0) return;
        usedIndices.pop();
        const inp = document.getElementById('wordInput');
        inp.value = inp.value.slice(0,-1);
        renderAll();
    }

    function shufflePool() {
        state.pool.sort(() => Math.random()-0.5);
        resetSelection();
        renderAll();
    }

    function resetSelection() {
        document.getElementById('wordInput').value = "";
        usedIndices = [];
        renderAll();
    }

    function updateMsg(txt, col) {
        const m = document.getElementById('msg');
        m.innerText = txt; m.style.color = col;
        setTimeout(() => m.innerText = "", 2000);
    }

    // Start systemu
    initDB();
</script>
</body>
</html>
